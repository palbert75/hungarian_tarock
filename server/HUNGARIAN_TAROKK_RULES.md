# Hungarian Tarokk (Illustrated Hungarian Tarokk / XX Hívás)

## Game Overview

**Players:** 4 active players (5-player variant: dealer sits out)
**Deck:** 42 cards (Industrie und Glück / Hungarian Tarot pack)
**Objective:** Declarer + Partner must score 48+ points (majority of 94 total points)
**Direction:** Counter-clockwise (anticlockwise)

**Rules Source:** https://www.pagat.com/tarot/xx-hivas.html

---

## Card Deck Composition (42 cards)

### Tarokk Cards (Trumps) - 22 cards

**Honours (5 points each):**
- **Skíz** - The Fool (highest tarokk, looks like a Joker)
- **XXI** - 21 (second highest)
- **Pagát (I)** - 1 (lowest tarokk, but still an honour)

**Numbered Tarokks (1 point each):**
- **XX, XIX, XVIII, XVII... down to II** (20 through 2)

### Suit Cards - 20 cards (5 per suit)

**Four suits:** Hearts (♥), Diamonds (♦), Spades (♠), Clubs (♣)

Each suit contains (highest to lowest):
- **King (Király, K)** - 5 points
- **Queen (Dáma, Q)** - 4 points
- **Rider/Cavalier (Lovas, C)** - 3 points
- **Jack (Bubi, J)** - 2 points
- **Ten/Ace** - 1 point

**Total Deck Value:** 94 points
- Honours: 3 × 5 = 15 points
- Other tarokks: 19 × 1 = 19 points
- Kings: 4 × 5 = 20 points
- Queens: 4 × 4 = 16 points
- Riders: 4 × 3 = 12 points
- Jacks: 4 × 2 = 8 points
- Tens: 4 × 1 = 4 points
- **Total: 94 points**

---

## Game Setup

1. **Seating:** 4 players (or 5 with 1 dealer sitting out)
2. **Random seating:** Players draw cards to determine seats
3. **Shuffle:** Dealer shuffles
4. **Cut:** Player to dealer's left cuts
5. **Dealing:**
   - 6 cards face-down to form the **talon**
   - 5 cards to each player (anticlockwise from dealer's right)
   - 4 more cards to each player
   - Each player has 9 cards total
6. **Direction:** All game actions proceed **counter-clockwise (anticlockwise)**

---

## Game Phases

### Phase 1: Bidding

**Starting position:** Player to the dealer's right

**Bid sequence (ascending order with game values):**
1. **Three (három)** - 1 game point - Take 3 cards from talon
2. **Two (kettő)** - 2 game points - Take 2 cards from talon
3. **One (egy)** - 3 game points - Take 1 card from talon
4. **Solo (szóló)** - 4 game points - Take 0 cards from talon

**Bidding Rules:**
- Proceeds counter-clockwise from dealer's right
- **Mandatory bid requirement:** Player MUST have **at least one honour** (skíz, XXI, or pagát) to bid at all
- If no honours: Player can only "pass"
- **Pass:** Player says "pass" and is out for this auction (cannot bid again)
- **Each bid must be higher than previous**, EXCEPT:
  - **Hold:** If you have **already bid** in this auction, you may "hold" to match the highest bid
  - Hold can only be used once per auction round
  - Cannot hold if you haven't bid yet
- **Solo:** Highest bid, ends auction immediately
- **All pass:** If all 4 players pass, cards are thrown in and next 4-5 hands are doubled-scoring
- **Declarer:** Player with highest bid (or who held last)

### Phase 2: Talon Distribution

**ALL players receive talon cards** (not just declarer!)

**Distribution based on declarer's winning bid:**
- **Solo:** Declarer takes 0 cards, remaining 6 cards distributed to other 3 players (2 each)
- **One:** Declarer takes 1 card, remaining 5 cards distributed to other 3 players
- **Two:** Declarer takes 2 cards, remaining 4 cards distributed to other 3 players
- **Three:** Declarer takes 3 cards, remaining 3 cards distributed to other 3 players (1 each)

**Distribution method:** Remaining talon cards divided as equally as possible among the 3 non-declarer players

### Phase 3: Discard Phase (ALL PLAYERS)

**ALL FOUR PLAYERS must discard** after adding their talon cards to hands

**Order:** Each player discards to get back to exactly 9 cards
- Discards are placed face-down
- Declarer's discards count toward declarer's team points
- Other players' discards count toward opponents' points

**CRITICAL DISCARD RESTRICTIONS:**
- **CANNOT discard Kings**
- **CANNOT discard Honours** (skíz, XXI, pagát)
- **Must announce:** Number of opponent tarokks discarded (if any)

**Hand Annulment (Optional):**
Players may annul the hand if holding:
- All four Kings
- Singleton XXI (only one tarokk, and it's XXI)
- Singleton pagát (only one tarokk, and it's pagát)
- No tarokks at all
- Only XXI + pagát (with restrictions if tarokks were discarded)

### Phase 4: Partner Call

**Declarer calls a specific tarokk** to designate their partner

**Standard call:** "I call XX" (Tarokk 20)

**Rules:**
- The player holding the called tarokk becomes declarer's partner
- **Partner's identity remains SECRET** until the called card is played
- **Cannot reveal partnership** through the bidding or announcements
- **Exceptions:** If declarer holds XX themselves, or if certain tarokks were discarded, different calling rules apply

**Teams:**
- **Declarer's team:** Declarer + Partner (2 players)
- **Opponents:** Other 2 players

### Phase 5: Announcements & Bonuses (Optional)

**Players may announce bonuses BEFORE first trick:**

**Available bonuses:**
1. **Trull:** Holding all 3 honours (skíz, XXI, pagát) - 1 pt silent / 2 pts announced
2. **Four Kings:** Holding all 4 Kings - 1 pt silent / 2 pts announced
3. **Double Game (duplajáték):** Predicting 71+ points - Doubles/quadruples game value
4. **Volát:** Predicting winning all 9 tricks - Triples/sextuples game value
5. **Pagát ultimó:** Pagát wins the last trick - 5 pts silent / 10 pts announced
6. **XXI-catch:** Skíz captures opponent's XXI - 21 pts silent / 42 pts announced

**8 or 9 Tarokks:** Players may declare holding 8 or 9 tarokks (1 pt silent / 2 pts announced from each player)

**Kontra/Rekontra:**
- Opponents may "kontra" (double) announced bonuses
- Declarer may "rekontra" (redouble)
- Further "szubkontra" possible

### Phase 6: Trick-Taking (9 Tricks)

**First trick lead:** Player to the **dealer's right** (regardless of who is declarer)
**Subsequent tricks:** Winner of the previous trick leads

**Playing Rules:**

1. **Leader:** May play any card
2. **Following players (counter-clockwise):**
   - **MUST follow suit** if able
   - **If VOID in lead suit:**
     - **MUST play a tarokk** if you have one
     - Only if you have no tarokks may you play any other suit

3. **Winning the trick:**
   - If any tarokks played: **Highest tarokk wins**
   - If no tarokks: **Highest card of lead suit wins**

4. **Turn order:** Counter-clockwise from leader

5. **Trick collection:** Winner collects all 4 cards face-down into their trick pile

**Special Rule - Pagát Ultimó:**
If pagát ultimó is announced, the pagát holder **may not play it until forced** by the above rules (must follow suit / must play tarokk when void)

### Phase 7: Scoring

**Counting Points:**
- Each team counts card points in their won tricks + discards
- Declarer's team: Declarer's tricks + Partner's tricks + Declarer's discards
- Opponents: Other players' tricks + their discards

**Winning Condition:**
- **Declarer's team needs 48+ points** (more than half of 94)
- If declarer's team has 48+: Declarer's team wins
- If opponents have 47+: Opponents win

**Game Value Calculation:**
- Base game value: Depends on bid (three=1, two=2, one=3, solo=4)
- Multipliers: Double game (×2/×4), Volát (×3/×6)
- Bonuses scored independently
- Kontras double the relevant amounts

**Payment:**
- Each opponent pays declarer the game value
- Partner receives same amount as declarer
- Bonuses paid separately

### Phase 8: Next Hand

- Dealer position rotates counter-clockwise
- New hand dealt
- Doubled-scoring may apply if previous hand was thrown in

---

## Implementation Architecture

### Tech Stack
- **Python 3.10+**
- **Server Framework:** FastAPI + python-socketio (WebSocket for real-time)
- **Data Models:** Pydantic (type safety and validation)
- **State Management:** In-memory (Redis for multi-instance scaling)
- **Testing:** pytest + pytest-asyncio
- **Logging:** structlog (structured logging)
- **Linting:** ruff (fast Python linter)

### Project Structure

```
tarokk-server/
├── server/
│   ├── models/
│   │   ├── __init__.py
│   │   ├── card.py          # Card, Suit, TarokkRank, CardType enums
│   │   ├── deck.py          # 42-card deck generation & shuffling
│   │   ├── player.py        # Player state, hand, tricks won
│   │   ├── game_state.py    # GameState, GamePhase enum, position tracking
│   │   └── bid.py           # Bid types, bid history
│   ├── game_logic/
│   │   ├── __init__.py
│   │   ├── bidding.py       # Bid validation, honour check, hold logic
│   │   ├── talon.py         # Talon distribution based on bid
│   │   ├── discard.py       # Discard validation (no kings/honours)
│   │   ├── partner.py       # Partner calling logic
│   │   ├── tricks.py        # Trick-taking rules, winner calculation
│   │   ├── scoring.py       # Point calculation, win condition
│   │   └── bonuses.py       # Bonus declarations, kontra/rekontra
│   ├── networking/
│   │   ├── __init__.py
│   │   ├── server.py        # FastAPI + SocketIO server
│   │   ├── protocol.py      # Message types, JSON schemas
│   │   └── room_manager.py  # 4-player room/lobby management
│   ├── validation/
│   │   ├── __init__.py
│   │   └── rules.py         # Legal move validation
│   ├── utils/
│   │   ├── __init__.py
│   │   └── position.py      # Counter-clockwise position helpers
│   ├── config.py            # Configuration settings
│   └── main.py              # Entry point
├── tests/
│   ├── __init__.py
│   ├── test_deck.py
│   ├── test_bidding.py
│   ├── test_talon.py
│   ├── test_discard.py
│   ├── test_tricks.py
│   ├── test_scoring.py
│   └── test_game_flow.py
├── requirements.txt
├── pyproject.toml
├── .env.example
└── HUNGARIAN_TAROKK_RULES.md (this file)
```

### State Machine Flow

```
WAITING
  ↓
DEALING (shuffle, deal 9 cards to each + 6 to talon)
  ↓
BIDDING (counter-clockwise from dealer's right, honour requirement)
  ↓
TALON_DISTRIBUTION (declarer + others receive talon cards)
  ↓
DISCARDING (all players discard to 9 cards, no kings/honours)
  ↓
PARTNER_CALL (declarer calls tarokk, typically XX)
  ↓
ANNOUNCEMENTS (optional bonuses, kontra)
  ↓
PLAYING (9 tricks, dealer's right leads first, winner leads next)
  ↓
SCORING (count points, determine winner, calculate payments)
  ↓
GAME_END
  ↓
WAITING (next hand, dealer rotates)
```

### Position Tracking

```python
# Positions: 0, 1, 2, 3 (4 players)
# Counter-clockwise progression in circular array

dealer_position: int (0-3)
dealer_right_position: (dealer_position + 1) % 4

# Next position counter-clockwise:
def next_position(current: int) -> int:
    return (current + 1) % 4

# Previous position (clockwise):
def prev_position(current: int) -> int:
    return (current - 1) % 4
```

### Communication Protocol (WebSocket)

**Client → Server Messages:**

```json
{
  "type": "join_room",
  "player_id": "uuid",
  "player_name": "Player1",
  "room_id": "room_uuid"
}

{
  "type": "ready"
}

{
  "type": "place_bid",
  "bid": "three" | "two" | "one" | "solo" | "pass" | "hold"
}

{
  "type": "discard_cards",
  "card_ids": ["card_uuid1", "card_uuid2", ...]
}

{
  "type": "call_partner",
  "tarokk_rank": "XX"
}

{
  "type": "announce_bonus",
  "bonus_type": "trull" | "four_kings" | "double_game" | "volat" | "pagat_ultimo",
  "announced": true
}

{
  "type": "kontra",
  "target": "bonus_type" | "game"
}

{
  "type": "play_card",
  "card_id": "card_uuid"
}
```

**Server → Client Messages:**

```json
{
  "type": "room_state",
  "players": [
    {"id": "uuid", "name": "Player1", "ready": true, "connected": true},
    ...
  ],
  "room_id": "room_uuid"
}

{
  "type": "game_state",
  "phase": "bidding",
  "current_turn": 2,
  "dealer_position": 0,
  "your_position": 1,
  "your_hand": [
    {"id": "uuid", "suit": "hearts", "rank": "K", "points": 5},
    ...
  ],
  "bid_history": [
    {"player": 0, "bid": "pass"},
    {"player": 1, "bid": "three"},
    ...
  ],
  "public_info": {
    "talon_remaining": 6,
    "tricks_won": [0, 0, 0, 0]
  }
}

{
  "type": "your_turn",
  "valid_actions": ["place_bid", "discard_cards", "play_card"],
  "valid_bids": ["three", "two", "hold", "pass"],
  "valid_cards": ["card_uuid1", "card_uuid2", ...],
  "must_play_tarokk": false
}

{
  "type": "bid_placed",
  "player": 2,
  "bid": "three"
}

{
  "type": "talon_distributed",
  "you_received": 2,
  "your_hand_size": 11
}

{
  "type": "player_discarded",
  "player": 1,
  "num_cards": 2,
  "tarokks_discarded": 0
}

{
  "type": "partner_called",
  "called_card": "XX"
}

{
  "type": "trick_started",
  "trick_number": 1,
  "leader": 0
}

{
  "type": "card_played",
  "player": 2,
  "card": {"suit": "tarokk", "rank": "XIX", "points": 1}
}

{
  "type": "trick_complete",
  "winner": 1,
  "cards": [...],
  "points_in_trick": 8,
  "partner_revealed": false
}

{
  "type": "game_over",
  "declarer": 1,
  "partner": 3,
  "declarer_team_points": 52,
  "opponent_team_points": 42,
  "winner": "declarer_team",
  "game_value": 3,
  "bonuses": [
    {"type": "trull", "winner": "declarer_team", "value": 2}
  ],
  "payments": {
    "0": -3,
    "1": +6,
    "2": -3,
    "3": +6
  }
}

{
  "type": "error",
  "code": "INVALID_DISCARD",
  "message": "Cannot discard Kings or Honours"
}
```

---

## Implementation Checklist

### Phase 1: Core Models ✓
- [ ] Card model (Suit enum, TarokkRank enum, CardType, point values)
- [ ] 42-card deck generation (4 suits × 5 cards + 22 tarokks)
- [ ] Deck shuffling and dealing logic
- [ ] Player model (id, name, hand, tricks_won, discard_pile, connection state)
- [ ] GameState model (phase, positions, dealer, current_turn, bid_history)
- [ ] Position utility functions (next_position, prev_position)

### Phase 2: Game Logic - Bidding
- [ ] Bid types (three, two, one, solo, pass, hold)
- [ ] Honour check validator (must have skíz, XXI, or pagát to bid)
- [ ] Hold validation (can only hold if already bid in this auction)
- [ ] Bid comparison (ascending order)
- [ ] Determine declarer (highest bidder or last holder)

### Phase 3: Game Logic - Talon & Discard
- [ ] Talon distribution based on bid
- [ ] Discard validation (cannot discard Kings or Honours)
- [ ] Discard count tracking per player
- [ ] Tarokk discard announcement
- [ ] Hand annulment conditions check

### Phase 4: Game Logic - Partner & Teams
- [ ] Partner calling (call specific tarokk, typically XX)
- [ ] Partner identity tracking (hidden until card played)
- [ ] Team determination (declarer+partner vs others)
- [ ] Partner reveal trigger (when called card is played)

### Phase 5: Game Logic - Trick-Taking
- [ ] First trick leader (dealer's right)
- [ ] Subsequent trick leader (previous winner)
- [ ] Follow suit validation
- [ ] Must-play-tarokk-if-void validation
- [ ] Trick winner calculation (highest tarokk or highest lead suit)
- [ ] Legal card determination for current player

### Phase 6: Game Logic - Scoring
- [ ] Card point calculation
- [ ] Team point aggregation (tricks + discards)
- [ ] Win condition (48+ points for declarer's team)
- [ ] Bonus tracking (trull, four kings, double game, volát, pagát ultimó)
- [ ] Game value calculation with multipliers
- [ ] Payment calculation

### Phase 7: Networking
- [ ] WebSocket server setup (FastAPI + python-socketio)
- [ ] Room/lobby management (4 players per room)
- [ ] Player connection/disconnection handling
- [ ] Message protocol handlers (join, bid, discard, play, etc.)
- [ ] Broadcast updates to all players in room
- [ ] Player reconnection support
- [ ] Timeout handling for inactive players

### Phase 8: Validation & Rules
- [ ] Legal move validator (combines all rules)
- [ ] Turn order enforcement
- [ ] Action phase validation (can only bid during bidding phase, etc.)
- [ ] Input sanitization
- [ ] Error responses with clear messages

### Phase 9: Testing
- [ ] Unit tests: Card, Deck, Player models
- [ ] Unit tests: Bidding logic (honour check, hold validation)
- [ ] Unit tests: Talon distribution
- [ ] Unit tests: Discard validation
- [ ] Unit tests: Trick-taking rules (follow suit, must play tarokk)
- [ ] Unit tests: Scoring calculation
- [ ] Integration tests: Full game flow
- [ ] Edge case tests: All pass, annulment, disconnects

### Phase 10: Polish
- [ ] Structured logging (game events, errors)
- [ ] Configuration management (port, host, timeouts)
- [ ] Documentation (API, setup instructions)
- [ ] Performance optimization
- [ ] Security review (input validation, rate limiting)

---

## Key Implementation Notes

### 1. Honours Check (Bidding)
```python
def can_bid(hand: List[Card]) -> bool:
    honours = {TarokkRank.SKIZ, TarokkRank.XXI, TarokkRank.PAGAT}
    return any(card.is_tarokk() and card.rank in honours for card in hand)
```

### 2. Talon Distribution
```python
def distribute_talon(bid: Bid, talon: List[Card]) -> Dict[int, List[Card]]:
    # bid: three→3, two→2, one→1, solo→0
    declarer_cards = talon[:bid.talon_count]
    remaining = talon[bid.talon_count:]
    # Distribute remaining equally among 3 other players
    return {
        "declarer": declarer_cards,
        "others": split_evenly(remaining, 3)
    }
```

### 3. Discard Validation
```python
def is_valid_discard(cards: List[Card]) -> Tuple[bool, str]:
    for card in cards:
        if card.is_king():
            return False, "Cannot discard Kings"
        if card.is_honour():  # skíz, XXI, pagát
            return False, "Cannot discard Honours"
    return True, "OK"
```

### 4. Must Play Tarokk When Void
```python
def get_legal_cards(hand: List[Card], lead_suit: Suit, has_lead_suit: bool) -> List[Card]:
    if has_lead_suit:
        return [c for c in hand if c.suit == lead_suit]

    # Void in lead suit
    tarokks = [c for c in hand if c.is_tarokk()]
    if tarokks:
        return tarokks  # MUST play tarokk
    else:
        return hand  # No tarokks, can play anything
```

### 5. Trick Winner
```python
def determine_trick_winner(trick: List[Tuple[int, Card]], lead_suit: Suit) -> int:
    tarokk_plays = [(pos, card) for pos, card in trick if card.is_tarokk()]

    if tarokk_plays:
        # Highest tarokk wins
        winner_pos, _ = max(tarokk_plays, key=lambda x: x[1].tarokk_value())
        return winner_pos
    else:
        # Highest card of lead suit wins
        lead_suit_plays = [(pos, card) for pos, card in trick if card.suit == lead_suit]
        winner_pos, _ = max(lead_suit_plays, key=lambda x: x[1].rank_value())
        return winner_pos
```

### 6. Counter-Clockwise Iterator
```python
def iter_counter_clockwise(start_pos: int, num_players: int = 4):
    """Iterate positions counter-clockwise from start_pos"""
    for i in range(num_players):
        yield (start_pos + i) % num_players
```

---

## Open Questions & Clarifications Needed

### Resolved ✓
- ✓ Discard phase order: Sequential counter-clockwise (one at a time)
- ✓ First trick leader: Dealer's right
- ✓ Subsequent trick leader: Previous trick winner
- ✓ Winning condition: 48+ points (card points, not tricks)
- ✓ Mandatory bid requirement: Must have at least one honour (skíz, XXI, or pagát)
- ✓ Talon distribution: ALL players receive cards from talon
- ✓ Discard restrictions: Cannot discard Kings or Honours

### Still TBD (Optional for MVP)
- Exact discard phase starting position (likely starts counter-clockwise from dealer's right)
- Partner calling when declarer holds XX (alternative calling rules)
- Kontra/Rekontra announcement timing
- Mayor's hat special rule details
- Hand annulment conditions when tarokks were discarded
- 5-player variant implementation

---

## Development Roadmap

### MVP (Minimum Viable Product)
- Core 4-player game
- Basic bidding (three, two, one, solo, pass, hold)
- Talon distribution & discard
- Partner calling (simple case: call XX)
- Trick-taking with all rules
- Basic scoring (48+ points to win)
- WebSocket server with room management

### Version 1.1
- Bonus announcements (trull, four kings)
- Advanced scoring with multipliers
- Hand annulment
- Pagát ultimó

### Version 1.2
- Kontra/Rekontra system
- Double game & Volát
- XXI-catch bonus
- Full payment calculation

### Version 2.0
- 5-player variant
- Persistent game history
- Player statistics
- Replay system
- AI players (future consideration)

---

## References

- **Primary rules source:** https://www.pagat.com/tarot/xx-hivas.html
- **Deck:** Industrie und Glück (42-card Hungarian Tarot pack)
- **Game family:** Tarot card games, trick-taking games
- **Variant name:** Illustrated Hungarian Tarokk / XX Hívás
